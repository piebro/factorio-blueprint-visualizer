<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="Online tool to artfully visualize Factorio Blueprints.">
  <title>Factorio Blueprint Visualizer</title>
  <link rel='shortcut icon' type='image/x-icon' href='website/favicon.ico'/>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
  <!-- <script defer data-domain="piebro.github.io/factorio-blueprint-visualizer" src="https://plausible.io/js/plausible.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script src="startExampleBlueprintString.js"></script>
  <script src="entity_properties.js"></script>
  <script src="buildingSettings.js"></script>
  <script src="drawingSettings.js"></script>
  <script src="blueprintVisualizer.js"></script>
  
</head>

<style>
img, svg {
  width:auto;
  height:auto;
  max-width: 92vw;
  max-height: 86vh;
  margin: auto;
  display: block;
  padding-top: 10px;
}

.button-container {
  text-align: center;
  float:center;
}

.btn {
  background-color: #04AA6D;
  color: white;
  padding: 16px;
  font-size: 16px;
  border: none;
  cursor: pointer;
}

.btn:hover{
  background-color: #3e8e41;
}
</style>

<script>

async function loadDefaultBlueprint() {
  try {
    const response = await fetch('test/test_blueprint_book.txt');
    const blueprintString = await response.text();
    return blueprintString;
  } catch (error) {
    console.error('Error loading default blueprint:', error);
    return START_EXAMPLE_BLUEPRINT; // Fallback to example if load fails
  }
}

function newBlueprintString(blueprintString){
  [currentBlueprintNames, currentBlueprintJsons] = getBlueprintList(blueprintString);
  currentBlueprint = getBlueprint(currentBlueprintJsons[0])

  getCurrentBlueprintEntityCount(currentBlueprint)

  prevSelection = document.getElementById('blueprintSelection');
  if (prevSelection != null) {
    prevSelection.remove();
  }

  if (currentBlueprintNames.length > 1){
    selection = document.createElement("select")
    selection.classList.add("btn")
    selection.setAttribute("id", "blueprintSelection")
    selection.setAttribute("style", "width: 160px;")
    selection.setAttribute("onChange", "blueprintSelectionOnChange(this)")
    for (i in currentBlueprintNames){
      option = document.createElement("option")
      option.setAttribute("value", i)
      option.innerHTML = currentBlueprintNames[i] || "unnamed"
      selection.appendChild(option)
    }
    document.getElementById("button-container").appendChild(selection)
    selection.selectedIndex = 2;
    blueprintSelectionOnChange(selection);
  }
}

async function setup(){
  const elem = document.createElement("img");
  elem.setAttribute("src", "website/start.svg");
  document.getElementById("svg-container").appendChild(elem);
  
  const defaultBlueprint = await loadDefaultBlueprint();
  newBlueprintString(defaultBlueprint);
  showBlueprint();
  console.log(getCurrentBlueprintEntityCount(currentBlueprint))

  document.addEventListener('keyup', onKeyUp);
}

function showBlueprint(){
  document.getElementById("svg-container").innerHTML = drawBlueprint(currentBlueprint, settingsList[currentSettingIndex], svgWidthInMm=300)
}

async function saveBtnClick(){
  svg_str = document.getElementById("svg-container").innerHTML

  const element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(svg_str));
  element.setAttribute('download', "blueprint.svg");

  element.style.display = 'none';
  document.body.appendChild(element);
  element.click();
  document.body.removeChild(element);
}

function blueprintSelectionOnChange(selectObject){
  currentBlueprint = getBlueprint(currentBlueprintJsons[selectObject.value])
  showBlueprint()
}

function uploadBtnClick(){
  input = window.prompt("paste blueprint here")
  if (input != null && input != ""){
    newBlueprintString(input)
    showBlueprint()
  }
}

function nextSetting(){
  currentSettingIndex += 1;
  if (settingsList.length == currentSettingIndex) {
    settingsList.push(getRandomSettings());
  }
  showBlueprint()
}

function previousSetting(){
  if (currentSettingIndex > 0) {
    currentSettingIndex -= 1;
    showBlueprint()
  }
}

function onKeyUp(e){
  if (e.code == "ArrowRight"){
    nextSetting()
  } else if (e.code == "ArrowLeft"){
    previousSetting()
  }
}

let settingsList = []
let currentSettingIndex = 0
let currentBlueprint = null
let currentBlueprintJsons = null
let currentBlueprintNames = null
settingsList.push(EXAMPLE_SETTINGS)

</script>
<body onload="setup()">

<div class="button-container" id="button-container">
  <button class="btn" id="nextSettingBtn" onclick="nextSetting()">Random Drawing Setting</button>
  <button class="btn" id="saveBtn" onclick="saveBtnClick()">Save</button>
  <button class="btn" id="uploadBtn" onclick="uploadBtnClick()">Upload Blueprint</button>
  <button class="btn" id="infoBtn" onclick="location.href='https://github.com/piebro/factorio-blueprint-visualizer?ref=piebro.github.io/factorio-blueprint-visualizer';">About</button>
  <button class="btn" id="infoBtn" onclick="location.href='https://piebro.github.io?ref=piebro.github.io/factorio-blueprint-visualizer';">Other Projects</button>
</div>

<div class="svg-container" id="svg-container"></div>

</body>
</html>
